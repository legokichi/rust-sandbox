import './style.css';
import xs from 'xstream';
import { Stream } from 'xstream';
import * as Cycle from '@cycle/run'
import { makeOpenLayersDriver } from './oldriver';
import type { OlCommand, OlSource, OlCommandAddWaypoint, Coordinate } from './oldriver';
import { makeGeoLocationDriver } from './geolocationdriver';
import type { GeoCommand, GeoSource } from './geolocationdriver';

async function listRiverWaypoints(o: { riverId: number, next?: number }): Promise<{ river_waypoints: Array<{ river_waypoint_id: number, name: string, latitude: number, longitude: number }>, next?: number }> {
  const { riverId, next } = o;
  const res = await fetch("https://litestream-sandbox-4h2uh5x4wa-an.a.run.app/api", {
    mode: "cors",
    method: "POST", credentials: "include", headers: { 'Accept': 'application/json', "Content-Type": "application/json" }, body: JSON.stringify({
      type: "listRiverWaypoints",
      riverId
    })
  });
  const json = await res.json();
  console.log(json);
  return json;
}
async function listRivers(o: { next?: number }): Promise<{ rivers: Array<{ river_id: number, name: string }>, next?: number }> {
  const { } = o;
  const res = await fetch("https://litestream-sandbox-4h2uh5x4wa-an.a.run.app/api", {
    mode: "cors",
    method: "POST", credentials: "include", headers: { 'Accept': 'application/json', "Content-Type": "application/json" }, body: JSON.stringify({
      type: "listRivers",
    })
  });
  const json = await res.json();
  console.log(json);
  return json;
}

interface Sources {
  OL: OlSource;
  GEO: GeoSource;
}

interface Sinks {
  OL: Stream<OlCommand>;
  GEO: Stream<GeoCommand>;
}

function main(o: Sources): Sinks {
  const {
    OL: { clickGps$, clickMap$, clickAddWaypoint$ },
    GEO: { pos$ },
  } = o;
  
  const posChanged$ = pos$.fold((prev, curr) => {
    return [prev[1], curr];
  }, [{
    longtiude: 0,
    latitude: 0,
    accuracy: 0
  }, {
    longtiude: 0,
    latitude: 0,
    accuracy: 0
  }]).filter(([a, b]) => a.accuracy !== b.accuracy || a.latitude !== b.latitude || a.longtiude !== b.longtiude).map(([_a, b]) => b);
  const ol$1: Stream<OlCommand> = xs.combine(clickGps$, posChanged$).map(
    ([_click, pos]): OlCommand => {
      return {
        type: "focus",
        longitude: pos.longtiude,
        latitude: pos.latitude,
      };
    }
  );
  const ol$2: Stream<OlCommand> = pos$.map(({
    longtiude,
    latitude,
    accuracy
  }): OlCommand => {
    return {
      type: "updateCurrentPosition",
      longtiude,
      latitude,
      accuracy
    };
  });
  const ol$3: Stream<OlCommand> = clickAddWaypoint$.map(({
    longitude,
    latitude
  }): OlCommand => {
    return {
      type: "addWaypoint",
      longitude,
      latitude,
    };
  });
  const ol$4 = clickMap$.filter((_) => false).map((_) => { throw new Error("unreachable") });
  // EPSG:4326 (WGS 84 の EPSGコード) 座標系

  const ol$5 = xs.fromPromise((async ()=>{
    const waypoints: Array<OlCommandAddWaypoint> = [];
    const { rivers } = await listRivers({});
    for (const river of rivers) {
      const { river_waypoints } = await listRiverWaypoints({ riverId: river.river_id });
      for (const river_waypoint of river_waypoints) {
        waypoints.push({
          type: "addWaypoint",
          // name: river_waypoint.name,
          longitude: river_waypoint.longitude,
          latitude: river_waypoint.latitude,
        });
      }
    }
    return xs.fromArray(waypoints);
  })()).flatten();
  return {
    OL: xs.merge(ol$1, ol$2, ol$3, ol$4, ol$5),
    GEO: xs.never(),
  };
}



Cycle.run(main as any, {
  GEO: makeGeoLocationDriver(),
  OL: makeOpenLayersDriver(),
} as any);



const waypoints: { [key: string]: Coordinate } = {
  "富士山": [138.7313889, 35.3622222],
  "秩父公園橋": [139.0719155531588, 36.002780508652975],
  "武之鼻橋": [139.0725162723582, 36.003201622651204],
  "せせらぎ荘の瀬": [139.0765789104678, 36.00723361904889],
  "ゴルフ場の瀬": [139.07697137565765, 36.01068857129275],
  "下水処理場の瀬": [139.07821077059012, 36.013009368087765],
  "秩父橋前のザラ瀬": [139.0838604619643, 36.01634060666794],
  "秩父橋前の隠れ岩": [139.08574555926472, 36.01751730197438],
  "秩父橋": [139.086117278947, 36.01785811396044],
  "旧秩父橋": [139.08650512930004, 36.01862531457782],
  "宮崎城跡前の瀬": [139.08889855209182, 36.02143244420989],
  "秩父太平洋セメント前のザラ瀬": [139.08909762763685, 36.02599732396122],
  "秩父太平洋セメント前の水制": [139.0877188250745, 36.02797501259279],
  "秩父太平洋セメントベルトコンベヤーの橋": [139.0858824694279, 36.02897258934499],
  "秩父太平洋セメント前の瀬": [139.08902304435563, 36.031320758803716],
  "送電線": [139.09226412930903, 36.03668446479628],
  "二股": [139.09367281644546, 36.040082273715484],
  "瀬": [139.0958552454708, 36.042222927153645],
  "諏訪城跡の瀬": [139.09948522336654, 36.042882528765844],
  "横瀬川流入": [139.09976136985387, 36.04440005756092],
  "地層のザラ瀬": [139.09935668758064, 36.04485715632296],
  "和銅大橋": [139.09906482029547, 36.045662765285755],
  "氷雨塚の瀬": [139.0987702435825, 36.04666107627774],
  "消波ブロック": [139.0990103603088, 36.05404306242967],
  "消波ブロックの瀬": [139.09844546520998, 36.05491127632135],
  "蒔田川前の地層ドロップ": [139.0955381337743, 36.05775360989348],
  "新皆野橋前の瀬": [139.09420292816912, 36.05990598040812],
  "新皆野橋（秩父やまなみ大橋）": [139.0937991035614, 36.06041177186199],
  "薬師堂下古墳の瀬": [139.0915281206684, 36.06325478563795],
  "皆野橋": [139.08683343011208, 36.066221192261494],
  "皆野橋の瀬": [139.08682814676, 36.06704496612902],
  "赤平川流入": [139.08633610146802, 36.068195303924625],
  "皆野駅前のザラ瀬": [139.0911909064733, 36.07224207747889],
  "皆野駅前のザラ瀬2": [139.0952014667693, 36.07460900018707],
  "栗谷瀬橋前の地層ドロップ": [139.0958315536906, 36.07710793544136],
  "栗谷瀬橋": [139.09648892709652, 36.07970773070484],
  "栗谷瀬橋下EP": [139.09910095952117, 36.08020459406606],
  "ウォーターパーク長瀞前のザラ瀬": [139.1029328438854, 36.08120521841272],
  "親鼻橋下EP（ライン下りAコース乗船場）": [139.11096796836785, 36.08218670597326],
  "親鼻橋": [139.1093862083123, 36.08201746611897],
  "親鼻鉄橋": [139.1143966034843, 36.08395693744913],
  "鉄橋下の瀬(1級)": [139.11503232956505, 36.084094960385954],
  "ステミの瀬(1.5級)": [139.11513116562165, 36.084365380354825],
  "セイゴの瀬(2級)": [139.11785814011483, 36.08581321213056],
  "コタキの瀬(2.5級)": [139.1172523238773, 36.08965099170375],
  "ライン下り発着場": [139.1152709330081, 36.09537404754023],
  "ピンポールの瀬(1級)": [139.11441676067753, 36.09919316977167],
  "白鳥荘二股の瀬(1.5級)": [139.11454012184967, 36.09972346220377],
  "金石水管橋": [139.11306485062124, 36.10517131775538],
  "キャンプ場前の瀬(1級)": [139.11316964362655, 36.10580907020025],
  "サイコロ岩": [139.11615904936005, 36.110159118014536],
  "高砂橋": [139.1167424927241, 36.11070389221439],
  "高砂橋の瀬(ドロップ)": [139.11693855014067, 36.11106753802916],
  "ライン下りゴール": [139.1186464790973, 36.11320768728517],
  "クツナシの瀬(1.5級)": [139.11926020969383, 36.11326318552129],
  "洗濯機の瀬(1級)": [139.11879485006364, 36.1144341517747],
  "ハーブ研究所の瀬": [139.11557811545947, 36.116718327617065],
  "ドビーの瀬(2級)": [139.11384175981132, 36.12104181534758],
  "宮沢の瀬": [139.11372611314187, 36.12342728651372],
  "岩田前EP": [139.11606475098313, 36.12473134411758],
  "岩田の瀬": [139.11706029437553, 36.12509438509453],
  "高橋の瀬": [139.11843891377535, 36.126238334622315],
  "最後の瀬": [139.12054374582158, 36.12927824388774],
  "消波ブロック2": [139.12094938205328, 36.12969096410883],
  "護岸の壁(ポーテージEP)": [139.12184727494045, 36.130187934893314],
  "国体コースの瀬": [139.1227239383733, 36.1301792098962],
  "左シュート右コース": [139.12307109432462, 36.1303786445835],
  "岩超えEP": [139.12327136351757, 36.13067374114304],
  "白鳥橋": [139.12635673431276, 36.13231132085089],
  "下郷EP": [139.13578485635776, 36.132373526147504],
  "寄居橋": [139.15642000228442, 36.125776760332926],
  "玉淀ダムのEP": [139.16127969112873, 36.117017779899484],
  "玉淀ダム": [139.16953024811244, 36.116160102616234],

  "常陸大子駅": [140.35080250269525, 36.770774326721806],
  "湯の里公園EP": [140.35742028244655, 36.76667757086997],
  "久慈川橋": [140.35813015837178, 36.762228431857224],
  "仮設橋PTG": [140.36966126454843, 36.76128870135851],
  "北田気大橋": [140.37006262045577, 36.76180190486879],
  "久野瀬橋（沈下橋）": [140.3783319930691, 36.76089391358181],
  "第六久慈川橋梁": [140.37919813174506, 36.7577207966265],
  "南田気大橋": [140.37662866812434, 36.75633516390502],
  "新昭和橋": [140.37670943379254, 36.75171239521721],
  "第五久慈川橋梁": [140.3796813213811, 36.75023381239245],
  "岩絡みの瀬": [140.38270137159387, 36.74486007191567],
  "下津原橋": [140.38243301294884, 36.74459249053717],
  "下津原橋下EP": [140.38200226378663, 36.74499555620106],
  "シャモの瀬(1.5)": [140.3750527069436, 36.73711161147121],
  "鰐ヶ淵橋": [140.3875716004426, 36.737070841048535],
  "瀬(1.5)": [140.38815405170078, 36.73704490865313],
  "奥久慈橋": [140.38770034647536, 36.73084565900146],
  "瀬2": [140.38805873334738, 36.73022838415318],
  "第四久慈川橋梁": [140.37781142501007, 36.73015776261283],
  "鉄橋下消波ブロック左岸ポーテージ": [140.37789722254547, 36.73043758359897],
  "瀬4": [140.37155335146826, 36.72481867353004],
  "上小川橋": [140.37274741438972, 36.72011377353866],
  "消波ブロック3": [140.3795158212913, 36.71775590298124],
  "第三久慈川橋梁": [140.38454913405548, 36.716295337227635],
  "消波ブロック4": [140.38439424486737, 36.71642633980228],
  "宮平橋": [140.3851586634755, 36.7169938866642],
  "消波ブロック5": [140.3888511573862, 36.714533737051525],
  "御城橋": [140.38701080503512, 36.71409471436456],
  "第二久慈川橋梁": [140.38660359788128, 36.71403313622072],
  "鉄橋下の瀬1": [140.38566898130327, 36.71427812035678],
  "仮設橋3PTG": [140.38364497056943, 36.71186910171957],
  "消波ブロック6": [140.38178855105178, 36.709356481032344],
  "消波ブロック7": [140.38310507726555, 36.69993083819344],
  "西金大橋": [140.38913742535934, 36.6923698465521],
  "大内野橋": [140.38873160599792, 36.684856256473466],
  "瀬(1)": [140.38843126445389, 36.68494379878156],
  "第一久慈川橋梁": [140.38747602314749, 36.67922582795006],
  "下小川橋": [140.3880044292847, 36.67758848782043],
  "橋下消波ブロック右岸ポーテージ": [140.38804273702493, 36.677555953140256],
  "左岸EP": [140.3884544639313, 36.6662684945092],
  "平山橋（沈下橋）": [140.3879894614594, 36.6658553575746],
  "堰": [140.38825731374612, 36.66230703709776],

  "白丸駅": [139.11484235039475, 35.81197300620613],
  "数馬峡橋": [139.11509811594544, 35.80979171198217],
  "白丸湖EP": [139.1163506934866, 35.81072660234875],

  "寒山寺 駐車場": [139.19349356696478, 35.803138785806055],
  "御岳駅": [139.18244153331304, 35.80143116199427],
  "御岳橋": [139.18297566550882, 35.8007385662186],
  "御岳EP": [139.18541866232138, 35.80160407389222],
  "鵜の瀬橋": [139.18844944967992, 35.804899355018506],
  "楓橋": [139.19410920654443, 35.80372655974858],
  "軍畑大橋": [139.20781173508183, 35.80522764257336],
  "奥多摩橋": [139.21562497429582, 35.80081643252839],
  "好文橋": [139.22136883783207, 35.79633162894858],
  "神代橋": [139.22766577508216, 35.789454976943176],
  "和田橋": [139.2315517872428, 35.78164251380883],
  "万年橋": [139.24920211499773, 35.7850013528697],
  "柳淵橋": [139.25435967856814, 35.7857529907149],
  "釜の淵公園EP": [139.25334577149258, 35.78578140172303],
  "釜の淵公園大柳駐車場": [139.25344139573681, 35.78564120889584],
  "釜の淵公園駐車場": [139.25569029811456, 35.784451978337216],
  "青梅駅": [139.25834360426683, 35.79027062559453],

  "奥利根湖ゲート": [139.05839374130173, 36.86386954837418],
  "矢木沢ダムEP": [139.05189725730443, 36.91221208964946],
  "矢木沢ダム駐車場": [139.05307807306556, 36.911018264155814],
  "奥利根湖事務所": [139.05227413894397, 36.91139461047338],

  "湖山荘": [139.13865245035691, 37.13544041743985],
  "奥只見山荘": [139.13818900179223, 37.134947794321036],
  "奥只見湖EP": [139.17101255341294, 37.134153898090474],
  "奥只見湖駐車場": [139.16956629399255, 37.13431510025438],


  "本栖湖駐車場": [138.60295772590936, 35.46320148088398],
  "本栖湖EP": [138.60195974446194, 35.4622899625447],

  "富士川親水公園駐車場": [138.47188663475953, 35.554366614655166],
  "富士川大橋1": [138.4768114976785, 35.55613440782284],
  "鰍沢口駅": [138.47080781594553, 35.54145715738298],
  "富士川橋1": [138.47322540493846, 35.550299291252585],
  "戸川": [138.46439487607435, 35.54510191211489],
  "富士橋": [138.45961623162015, 35.53952615492956],
  "大柳川流入": [138.4548873789371, 35.515876552258774],
  "鹿島橋": [138.45861729413375, 35.512603467908775],
  "月見橋": [138.44959176207533, 35.49637094024685],
  "甲斐岩間駅": [138.4630850869858, 35.49249027660201],
  "峡南橋": [138.45485574929825, 35.484738742469574],
  "富士川橋": [138.44199594412981, 35.46550078152008],
  "中富橋": [138.4452317525275, 35.45696064399594],
  "飯富橋": [138.43831307098074, 35.440289832643444],
  "早川流入": [138.44748161174053, 35.426597286504986],
  "富山橋": [138.45294904590992, 35.419777126113715],
  "常葉川流入": [138.45648865167948, 35.41586778803813],
  "波高島駅": [138.45981789108538, 35.41859861054476],
  "塩之沢駅": [138.45386024391934, 35.379670175570226],
  "塩之沢堰": [138.4501427945582, 35.377015810575216],
  "波木井川": [138.44726062990574, 35.371184455149645],
  "身延橋": [138.4514580235213, 35.36478176922981],
  "身延駅": [138.45308096672835, 35.36150773750484],
  "甲斐大島駅": [138.4521067541609, 35.32823615100236],
  "富士川大橋": [138.4510173776276, 35.312230879504355],
  "南部橋": [138.45970208874013, 35.28222816660437],
  "内船駅": [138.46482856594386, 35.282155835056514],
  "寄畑駅": [138.47512493411136, 35.264880078200974],
  "富栄橋": [138.4811168455151, 35.25342631863475],
  "道の駅とみざわ": [138.48513524467853, 35.24332964682044],
  "福士川流入": [138.48708300296872, 35.24146405720441],
  "十島堰": [138.50586565828345, 35.23832710760807],
  "佐野川流入": [138.5094602546501, 35.237307029828955],
  "十島駅": [138.51603584673128, 35.23014756796282],
  "十島の瀬2級": [138.51533999478085, 35.22721859020264],
  "万栄橋": [138.5180129061753, 35.22779017492714],
  "稲子駅": [138.5368799914983, 35.23052488521837],
  "稲子川流入": [138.536906402033, 35.227562006027355],
  "稲子の瀬": [138.53496335630723, 35.226629842537704],
  "前釜の瀬3級": [138.55425763925237, 35.204272619196416],
  "新内房橋": [138.5545031545685, 35.20250720553369],
  "内房橋": [138.55476557827666, 35.2004031671902],
  "稲瀬川流入": [138.55340256402835, 35.19715243584423],
  "釜口の瀬3級": [138.55773492077668, 35.20085939714659],
  "釜口橋": [138.55809016307515, 35.20045316959596],
  "芝川流入": [138.56241024946132, 35.19823565334232],
  "芝川駅": [138.56400535068263, 35.197267893766195],
  "デビの瀬2級": [138.5633429201132, 35.19295789367891],
  "ポッキズリーブの瀬2級": [138.5652543552868, 35.19087269778038],
  "富原橋": [138.56997771342915, 35.1922118046794],
  "ドラゴンの瀬2級": [138.5759833119094, 35.195005114030636],
  "クラッシャーの瀬2級": [138.58244307825944, 35.195509767580134],
  "沼久保駅": [138.58445290179128, 35.19919045161812],
  "蓬莱橋": [138.58993334850007, 35.19400042725135],


  "湯檜曽駅ゆびそ": [138.98646812422595, 36.80322412356702],
  "スタート": [138.9884753879484, 36.80375698348929],
  "幸知橋こうちばし": [138.98735164626947, 36.79961110116844],
  "ダイナマイトの瀬": [138.99059569321594, 36.7967844876507],
  "スリーシスターズ＆ザ・ウォールの瀬": [138.99011974357992, 36.79578160890378],
  "水明荘プットイン": [138.97708703494513, 36.78540756603442],
  "スリーウェイズの瀬": [138.9770931868941, 36.78455185334815],
  "第八利根川橋梁": [138.98283086560878, 36.790323062983006],
  "大鹿橋": [138.9766704935036, 36.784031959986635],
  "第七利根川橋梁": [138.97646159887333, 36.78362823967291],
  "第六利根川橋梁": [138.9735632252436, 36.782947280807335],
  "谷川橋": [138.96821152955684, 36.781990133152945],
  "JA前プットイン": [138.96677312289464, 36.7774973059239],
  "湯原橋": [138.97063062448825, 36.773363336652665],
  "水上ウェーブスの瀬": [138.97147983563187, 36.76974757801139],
  "水上橋": [138.97156398476886, 36.768628606015255],
  "紅葉橋": [138.97054310545406, 36.76603688333975],
  "笹笛橋": [138.97087135326413, 36.76114514369988],
  "AKIKOの瀬": [138.97088591255465, 36.76106651773138],
  "諏訪峡大橋": [138.97360567249578, 36.75972134449587],
  "竜ヶ瀬": [138.974034879457, 36.75954160380678],
  "フリッパーズの瀬": [138.9760166884277, 36.758177067158655],
  "ショットガンの瀬": [138.97661906450782, 36.757554758588654],
  "メガウォッシュの瀬": [138.97692817854886, 36.75672923942963],
  "銚子橋": [138.97655153538128, 36.7532096446173],
  "銚子橋プットイン": [138.97552810937503, 36.75214311165925],
  "なすびホールの瀬": [138.9781666596558, 36.747801219938125],
  "ホットウェーブスの瀬": [138.98349476219892, 36.738766121460486],
  "吾妻橋": [138.98278202114417, 36.73762377278045],
  "利根橋": [138.97980631828187, 36.72374507030281],
  "木の根ホール": [138.97928443048318, 36.72399585071685],
  "利根橋前堰堤": [138.98053408897837, 36.723446772824914],
  "上牧発電所前堰堤": [138.9786200431598, 36.71349645771582],
  "大峰橋": [138.9788558778381, 36.7098484321733],
  "関越ウェーブス": [138.9788141917799, 36.708539838986425],
  "スラッパー": [138.9788339231861, 36.70348716046914],
  "矢瀬橋": [138.9826917940874, 36.699031140868826],
  "ホタル": [138.98366348297225, 36.695962294825236],
  "テトリス": [138.98371593193784, 36.69518556598884],
  "ナイスビューの瀬": [138.99620885423485, 36.68079081338186],
  "月夜野橋": [138.99610045867362, 36.682398398382205],
  "徒渡橋ただわたり": [138.9963700365566, 36.678581885488626],
  "月夜野大橋": [139.00149373024783, 36.669813041488496],
  "Fカップの瀬": [139.0023276045115, 36.66932950517871],
  "道路情報ターミナル 多機能トイレ": [139.0110442726823, 36.664933521722546],
  "地蔵橋": [139.02778439084656, 36.63972594642],
  "ファイナルファンタジーの瀬": [139.0243775898637, 36.64143667107351],
  "沼田大橋": [139.03070985289065, 36.637617021527035],
  "鷺石橋": [139.03726765029992, 36.632333244343144],
  "地蔵橋下プットオン": [139.0282047086552, 36.638934955462005],
  "第五利根川橋梁": [139.03867495184215, 36.63077991146899],
  "瀬3": [139.03940878587812, 36.62976319126622],
  "沼田八景 利根の早瀬": [139.03722507438027, 36.627159401146585],
  "戸鹿野橋": [139.04116811244825, 36.618815624200664],
  "久呂保橋": [139.0472740368721, 36.60483745846642],
  "綾戸ダム": [139.0547895534436, 36.589052832779984],
  "鉄道橋": [139.0560660244634, 36.58407594931748],
  "鉄道橋2": [139.05519885148826, 36.584130922346986],
  "綾戸簗": [139.053945281247, 36.58447965734172],
  "綾戸橋": [139.04971553622937, 36.581384901678575],
  "鉄道橋3": [139.052386800509, 36.57382824307513],
  "鉄道橋4": [139.04111946988132, 36.563923474598965],
  "赤い水管橋の瀬": [139.0394581253221, 36.5545498667485],
  "敷島橋": [139.0304686300708, 36.54588397300043],
  "浅田橋": [139.02803204647716, 36.53504477250246],
  "ユートピアの瀬": [139.02678840194574, 36.537389806226926],
  "宮田橋": [139.0208017114243, 36.526113655256964],
  "渋川医療センターテイクアウト": [139.01969163625554, 36.51041113985781],

  "烏山大橋手前の堰堤": [140.17254208612061, 36.65290029452072],
  "烏山駅": [140.15510528663455, 36.65018180982099],
  "烏山大橋": [140.16907113642833, 36.65188872486162],
  "下野大橋": [140.16494150804505, 36.63184825763848],
  "大瀬橋": [140.18929236115102, 36.57257759752949],
  "大蔵橋": [140.21081109338797, 36.57578521418853],
  "新那珂川橋": [140.24281410560286, 36.563579084432604],
  "御前山橋": [140.29696044084136, 36.562241480524136],
  "那珂川大橋": [140.33157895368552, 36.547033171478134],
  "那珂川大橋EP": [140.329415301655, 36.54781664038329],
  "道の駅かつら": [140.33384235049834, 36.54441535914155],
  "道の駅かつらキャンプ場": [140.33293390761156, 36.546102742907166]
};